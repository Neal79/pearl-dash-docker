<template>
  <v-app>
    <!-- Navigation Drawer -->
    <v-navigation-drawer
      v-model="drawer"
      :rail="rail && !mobile"
      :permanent="!mobile"
      :temporary="mobile"
      :mobile-breakpoint="960"
      color="surface"
      elevation="1"
      :width="280"
      :rail-width="72"
    >
      <!-- Navigation Header -->
      <div class="px-4 py-6">
        <div v-if="!rail" class="d-flex align-center">
          <v-avatar color="primary" size="40" class="mr-3">
            <v-icon color="white" size="24">mdi-view-dashboard</v-icon>
          </v-avatar>
          <div>
            <div class="text-h6 font-weight-bold">Pearl Dash</div>
            <div class="text-caption text-medium-emphasis">Dashboard</div>
          </div>
        </div>
        
        <div v-else class="d-flex justify-center">
          <v-avatar color="primary" size="40">
            <v-icon color="white" size="24">mdi-view-dashboard</v-icon>
          </v-avatar>
        </div>
      </div>

      <v-divider class="mb-2" />

      <!-- Main Navigation -->
      <v-list
        density="compact"
        nav
        class="px-2"
      >
        <v-list-item
          v-for="item in mainNavItems"
          :key="item.value"
          :prepend-icon="item.icon"
          :title="item.title"
          :value="item.value"
          :active="item.active"
          color="primary"
          rounded="xl"
          class="mb-1"
          @click="setActiveItem(item.value)"
        >
          <template v-slot:append v-if="item.badge">
            <v-badge
              :content="item.badge"
              color="error"
              inline
            />
          </template>
        </v-list-item>
      </v-list>

      <!-- Secondary Navigation -->
      <div class="mt-6">
        <v-list-subheader v-if="!rail" class="px-4 text-medium-emphasis">
          TOOLS
        </v-list-subheader>
        
        <v-list
          density="compact"
          nav
          class="px-2"
        >
          <v-list-item
            v-for="item in toolsNavItems"
            :key="item.value"
            :prepend-icon="item.icon"
            :title="item.title"
            :value="item.value"
            :active="item.active"
            color="primary"
            rounded="xl"
            class="mb-1"
            @click="setActiveItem(item.value)"
          />
        </v-list>
      </div>

      <!-- Bottom Navigation -->
      <template v-slot:append>
        <div class="pa-2">
          <v-divider class="mb-2" />
          
          <v-list density="compact" nav>
            <v-list-item
              prepend-icon="mdi-cog"
              title="Settings"
              value="settings"
              color="primary"
              rounded="xl"
              :active="activeItem === 'settings'"
              @click="setActiveItem('settings')"
            />
            
            <v-list-item
              prepend-icon="mdi-help-circle"
              title="Help & Support"
              value="help"
              color="primary"
              rounded="xl"
              :active="activeItem === 'help'"
              @click="setActiveItem('help')"
            />
          </v-list>

          <!-- User Profile (collapsed state) -->
          <div v-if="!rail" class="px-3 py-4 mt-2">
            <div class="d-flex align-center">
              <v-avatar size="32" color="secondary" class="mr-3">
                <v-icon color="white" size="18">mdi-account</v-icon>
              </v-avatar>
              <div class="flex-grow-1">
                <div class="text-body-2 font-weight-medium">Admin User</div>
                <div class="text-caption text-medium-emphasis">admin@example.com</div>
              </div>
              <v-btn
                icon="mdi-dots-vertical"
                size="small"
                variant="text"
                density="compact"
              />
            </div>
          </div>
        </div>
      </template>
    </v-navigation-drawer>

    <!-- App Bar -->
    <v-app-bar
      :elevation="0"
      color="surface"
      border="b"
      height="64"
    >
      <!-- Navigation Toggle -->
      <v-app-bar-nav-icon
        @click="toggleDrawer"
        :icon="rail ? 'mdi-menu-open' : 'mdi-menu'"
      />

      <!-- Page Title -->
      <v-app-bar-title class="font-weight-bold">
        {{ currentPageTitle }}
      </v-app-bar-title>

      <v-spacer />

      <!-- Action Buttons -->
      <div class="d-flex align-center ga-1">
        <!-- Add Device Button -->
        <v-btn
          color="primary"
          prepend-icon="mdi-plus"
          @click="showAddModal = true"
        >
          Add Device
        </v-btn>
        
        <!-- Search (hidden on mobile) -->
        <v-btn
          v-if="!mobile"
          icon="mdi-magnify"
          variant="text"
          density="comfortable"
        />
        
        <!-- Notifications -->
        <v-btn
          icon="mdi-bell"
          variant="text"
          density="comfortable"
          size="small"
        >
          <v-badge
            content="3"
            color="error"
            offset-x="2"
            offset-y="2"
          >
            <v-icon>mdi-bell</v-icon>
          </v-badge>
        </v-btn>

        <!-- Theme Toggle (hidden on mobile) -->
        <v-btn
          v-if="!mobile"
          :icon="isDark ? 'mdi-weather-sunny' : 'mdi-weather-night'"
          variant="text"
          density="comfortable"
          @click="toggleTheme"
        />

        <!-- Profile Menu -->
        <v-menu location="bottom end">
          <template v-slot:activator="{ props }">
            <v-btn
              v-bind="props"
              variant="text"
              density="comfortable"
              size="small"
            >
              <v-avatar :size="mobile ? 28 : 32" color="primary">
                <v-icon color="white" size="16">mdi-account</v-icon>
              </v-avatar>
            </v-btn>
          </template>

          <v-card :min-width="mobile ? 160 : 200">
            <v-list density="compact">
              <v-list-item
                prepend-icon="mdi-account"
                title="Profile"
                :subtitle="mobile ? undefined : 'View profile'"
              />
              <v-list-item
                prepend-icon="mdi-cog"
                title="Settings"
                :subtitle="mobile ? undefined : 'Manage account'"
              />
              <!-- Theme toggle for mobile -->
              <v-list-item
                v-if="mobile"
                :prepend-icon="isDark ? 'mdi-weather-sunny' : 'mdi-weather-night'"
                :title="isDark ? 'Light Mode' : 'Dark Mode'"
                @click="toggleTheme"
              />
              <v-divider />
              <v-list-item
                prepend-icon="mdi-logout"
                title="Sign Out"
                base-color="error"
                @click="handleLogout"
              />
            </v-list>
          </v-card>
        </v-menu>
      </div>
    </v-app-bar>

    <!-- Main Content Area -->
    <v-main :class="{ 'fullscreen-main': isFullscreen }">
      <!-- Fullscreen Mode - render directly in v-main, bypass container -->
      <div v-if="isFullscreen" class="fullscreen-container">
        <PearlDeviceCard 
          :device="devices.find(d => d.id === fullscreenDeviceId)!" 
          @remove="removeDevice"
          @toggle-fullscreen="toggleFullscreen"
          :is-fullscreen="true"
          class="fullscreen-card"
        />
      </div>

      <!-- Normal Mode - use container -->
      <v-container 
        v-else
        fluid 
        :class="mobile ? 'pa-4' : 'pa-6'"
        class="main-container fill-height"
      >
        <!-- Loading State -->
        <div v-if="loading" class="d-flex justify-center align-center" style="height: 200px;">
          <v-progress-circular 
            indeterminate 
            color="primary" 
            size="64"
          />
        </div>

        <!-- Empty State -->
        <div v-else-if="devices.length === 0" class="d-flex flex-column align-center justify-center" style="height: 400px;">
          <v-icon size="120" color="grey-lighten-1" class="mb-6">
            mdi-monitor-off
          </v-icon>
          <div class="text-h4 text-medium-emphasis mb-4">No devices added yet</div>
          <div class="text-body-1 text-medium-emphasis mb-6 text-center" style="max-width: 400px;">
            Get started by adding your first Pearl device to begin monitoring audio streams and managing recordings.
          </div>
          <v-btn
            color="primary"
            size="large"
            prepend-icon="mdi-plus"
            @click="showAddModal = true"
          >
            Add Your First Device
          </v-btn>
        </div>

        <!-- Pearl Device Cards Grid with Drag and Drop -->
        <div v-else>
          <!-- Normal Grid Mode -->
          <draggable 
            v-model="devices" 
            :disabled="mobile"
            ghost-class="ghost"
            chosen-class="no-effect"
            drag-class="drag"
            @start="onDragStart"
            @end="onDragEnd"
            item-key="id"
            class="device-grid"
          >
            <template #item="{ element: device }">
              <div class="device-grid-item draggable-item">
                <PearlDeviceCard 
                  :device="device" 
                  @remove="removeDevice"
                  @toggle-fullscreen="toggleFullscreen"
                  :is-fullscreen="false"
                  :class="dragging ? 'dragging-card' : ''"
                />
              </div>
            </template>
          </draggable>
        </div>
      </v-container>
    </v-main>

    <!-- Add Device Modal -->
    <AddDeviceModalVuetify
      v-if="showAddModal"
      @add="addDevice"
      @close="showAddModal = false"
    />

    <!-- Success Snackbar -->
    <v-snackbar
      v-model="snackbar.show"
      :color="snackbar.color"
      :timeout="3000"
      location="top"
    >
      {{ snackbar.message }}
      <template v-slot:actions>
        <v-btn
          variant="text"
          @click="snackbar.show = false"
        >
          Close
        </v-btn>
      </template>
    </v-snackbar>
  </v-app>
</template>

<script setup lang="ts">
// @claude: protected logic, do not modify without CLAUDE.md review section
import { ref, computed, onMounted, watch } from 'vue'
import { useTheme, useDisplay } from 'vuetify'
import { router } from '@inertiajs/vue3'
import { useApiAuth } from '@/composables/useApiAuth'
import draggable from 'vuedraggable'
import PearlDeviceCard from '@/components/PearlDeviceCard.vue'
import AddDeviceModalVuetify from '@/components/AddDeviceModalVuetify.vue'

interface Device {
  id: number
  name?: string
  ip: string
  username: string
  password: string
}

interface DeviceFormData {
  ip: string
  name: string
  username: string
  password: string
}

// Theme management
const theme = useTheme()
const isDark = computed(() => theme.global.current.value.dark)

// Mobile detection
const { mobile } = useDisplay()

const toggleTheme = () => {
  theme.global.name.value = isDark.value ? 'light' : 'dark'
  localStorage.setItem('theme', theme.global.name.value)
}

// Navigation state management
const drawer = ref(true)
const rail = ref(false)
const activeItem = ref('dashboard')

// Load drawer state from localStorage
const loadDrawerState = () => {
  const saved = localStorage.getItem('dashboard-drawer-state')
  if (saved) {
    const state = JSON.parse(saved)
    // Default to closed on mobile, open on desktop
    drawer.value = mobile.value ? false : (state.drawer ?? true)
    rail.value = state.rail ?? false
  } else {
    // Initial state: closed on mobile, open on desktop
    drawer.value = !mobile.value
    rail.value = false
  }
}

// Save drawer state to localStorage
const saveDrawerState = () => {
  localStorage.setItem('dashboard-drawer-state', JSON.stringify({
    drawer: drawer.value,
    rail: rail.value
  }))
}

// Watch for state changes and persist them
watch([drawer, rail], () => {
  saveDrawerState()
}, { deep: true })

// Toggle drawer rail mode
const toggleDrawer = () => {
  if (mobile.value) {
    // On mobile: just toggle drawer open/closed
    drawer.value = !drawer.value
  } else {
    // On desktop: cycle through states
    if (drawer.value && !rail.value) {
      rail.value = true
    } else if (rail.value) {
      rail.value = false
    } else {
      drawer.value = true
    }
  }
}

// Navigation items
const mainNavItems = ref([
  {
    title: 'Dashboard',
    icon: 'mdi-view-dashboard',
    value: 'dashboard',
    active: true,
  },
  {
    title: 'Devices',
    icon: 'mdi-monitor',
    value: 'devices',
    active: false,
    badge: '0',
  },
  {
    title: 'Audio Streams',
    icon: 'mdi-headphones',
    value: 'streams',
    active: false,
  },
  {
    title: 'Analytics',
    icon: 'mdi-chart-line',
    value: 'analytics',
    active: false,
  },
  {
    title: 'Recordings',
    icon: 'mdi-record-rec',
    value: 'recordings',
    active: false,
  },
])

const toolsNavItems = ref([
  {
    title: 'System Health',
    icon: 'mdi-heart-pulse',
    value: 'health',
    active: false,
  },
  {
    title: 'Logs',
    icon: 'mdi-text-box-multiple',
    value: 'logs',
    active: false,
  },
  {
    title: 'API Explorer',
    icon: 'mdi-api',
    value: 'api',
    active: false,
  },
])

// Set active navigation item
const setActiveItem = (value: string) => {
  activeItem.value = value
  
  // Reset all items
  mainNavItems.value.forEach(item => item.active = false)
  toolsNavItems.value.forEach(item => item.active = false)
  
  // Set active item
  const allItems = [...mainNavItems.value, ...toolsNavItems.value]
  const item = allItems.find(item => item.value === value)
  if (item) {
    item.active = true
  }
}

// Current page title based on active item
const currentPageTitle = computed(() => {
  const allItems = [...mainNavItems.value, ...toolsNavItems.value]
  const item = allItems.find(item => item.value === activeItem.value)
  return item?.title || 'Dashboard'
})

// Device management state
const devices = ref<Device[]>([])
const loading = ref(true)
const showAddModal = ref(false)
const dragging = ref(false)

// API authentication
const apiAuth = useApiAuth()

// Fullscreen state
const fullscreenDeviceId = ref<number | null>(null)
const isFullscreen = computed(() => fullscreenDeviceId.value !== null)

// Snackbar for notifications
const snackbar = ref({
  show: false,
  message: '',
  color: 'success'
})

// Card order persistence
const DEVICE_ORDER_KEY = 'pearl-dashboard-device-order'

const saveDeviceOrder = () => {
  try {
    const orderData = devices.value.map(device => device.id)
    localStorage.setItem(DEVICE_ORDER_KEY, JSON.stringify(orderData))
    console.log('ðŸ’¾ Device order saved:', orderData)
  } catch (error) {
    console.warn('Failed to save device order:', error)
  }
}

const restoreDeviceOrder = (loadedDevices: Device[]) => {
  try {
    const savedOrder = localStorage.getItem(DEVICE_ORDER_KEY)
    if (!savedOrder) return loadedDevices

    const orderIds = JSON.parse(savedOrder) as number[]
    console.log('ðŸ“‚ Restoring device order:', orderIds)

    // Sort devices according to saved order
    const orderedDevices = [...loadedDevices]
    orderedDevices.sort((a, b) => {
      const aIndex = orderIds.indexOf(a.id)
      const bIndex = orderIds.indexOf(b.id)
      
      // If device not in saved order, put it at the end
      if (aIndex === -1) return 1
      if (bIndex === -1) return -1
      
      return aIndex - bIndex
    })

    return orderedDevices
  } catch (error) {
    console.warn('Failed to restore device order:', error)
    return loadedDevices
  }
}

// Load devices from API
const loadDevices = async () => {
  try {
    loading.value = true
    const data = await apiAuth.get<Device[]>('/api/devices')
    
    // Restore saved order
    devices.value = restoreDeviceOrder(data)
    
    // Update badge count
    const devicesNavItem = mainNavItems.value.find(item => item.value === 'devices')
    if (devicesNavItem) {
      devicesNavItem.badge = devices.value.length.toString()
    }
  } catch (error) {
    console.error('Error loading devices:', error)
    showSnackbar('Failed to load devices', 'error')
  } finally {
    loading.value = false
  }
}

// Add device handler
const addDevice = async (deviceData: DeviceFormData) => {
  try {
    const data = await apiAuth.post<Device>('/api/devices', deviceData)
    devices.value.push(data)
    showAddModal.value = false
    showSnackbar(`Device ${data.name || data.ip} added successfully!`, 'success')
    
    // Save new order with added device
    saveDeviceOrder()
    
    // Update badge count
    const devicesNavItem = mainNavItems.value.find(item => item.value === 'devices')
    if (devicesNavItem) {
      devicesNavItem.badge = devices.value.length.toString()
    }
  } catch (error: any) {
    console.error('Error adding device:', error)
    const message = error.response?.data?.message || 'Failed to add device'
    showSnackbar(message, 'error')
  }
}

// Remove device handler
const removeDevice = async (deviceId: number) => {
  try {
    await apiAuth.delete(`/api/devices/${deviceId}`)
    const removedDevice = devices.value.find(d => d.id === deviceId)
    devices.value = devices.value.filter(d => d.id !== deviceId)
    
    showSnackbar(`Device ${removedDevice?.name || removedDevice?.ip} removed successfully!`, 'success')
    
    // Update saved order after removal
    saveDeviceOrder()
    
    // Update badge count
    const devicesNavItem = mainNavItems.value.find(item => item.value === 'devices')
    if (devicesNavItem) {
      devicesNavItem.badge = devices.value.length.toString()
    }
  } catch (error) {
    console.error('Error removing device:', error)
    showSnackbar('Failed to remove device', 'error')
  }
}

// Drag and drop handlers
const onDragStart = () => {
  dragging.value = true
}

const onDragEnd = () => {
  dragging.value = false
  
  // Save the new order to localStorage
  saveDeviceOrder()
  
  // Log the new order
  console.log('ðŸ“‹ New device order:', devices.value.map(d => ({ id: d.id, name: d.name || d.ip })))
}

// Fullscreen toggle handler
const toggleFullscreen = (deviceId: number) => {
  if (fullscreenDeviceId.value === deviceId) {
    // Exit fullscreen
    fullscreenDeviceId.value = null
    console.log('ðŸ“º Exited fullscreen mode')
  } else {
    // Enter fullscreen
    fullscreenDeviceId.value = deviceId
    const device = devices.value.find(d => d.id === deviceId)
    console.log(`ðŸ“º Entered fullscreen mode for ${device?.name || device?.ip}`)
  }
}

// Show snackbar helper
const showSnackbar = (message: string, color: string = 'success') => {
  snackbar.value = {
    show: true,
    message,
    color
  }
}

// Handle logout
const handleLogout = async () => {
  try {
    router.post('/logout', {}, {
      onSuccess: () => {
        showSnackbar('Logged out successfully', 'success')
      },
      onError: (errors) => {
        console.error('Logout failed:', errors)
        showSnackbar('Logout failed', 'error')
      }
    })
  } catch (error) {
    console.error('Unexpected error during logout:', error)
    showSnackbar('An unexpected error occurred', 'error')
  }
}

// Initialize component
onMounted(() => {
  loadDrawerState()
  
  // Load theme from localStorage
  const savedTheme = localStorage.getItem('theme')
  if (savedTheme) {
    theme.global.name.value = savedTheme
  }
  
  // Load devices
  loadDevices()
})
</script>

<style scoped>
/* Fix main content overflow */
.main-container {
  max-width: 100vw;
  overflow-x: hidden;
}

.min-height-content {
  min-height: calc(100vh - 64px);
}

/* Mobile-specific adjustments */
@media (max-width: 960px) {
  :deep(.v-app-bar-title) {
    font-size: 1.1rem !important;
  }
  
  /* Ensure content doesn't overflow */
  :deep(.v-main) {
    overflow-x: hidden;
  }
}

/* Custom app bar shadow */
:deep(.v-app-bar) {
  backdrop-filter: blur(10px);
}

/* Smooth transitions */
.v-navigation-drawer {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar for navigation */
:deep(.v-navigation-drawer__content) {
  scrollbar-width: thin;
  scrollbar-color: rgb(var(--v-theme-outline-variant)) transparent;
}

:deep(.v-navigation-drawer__content)::-webkit-scrollbar {
  width: 4px;
}

:deep(.v-navigation-drawer__content)::-webkit-scrollbar-track {
  background: transparent;
}

:deep(.v-navigation-drawer__content)::-webkit-scrollbar-thumb {
  background-color: rgb(var(--v-theme-outline-variant));
  border-radius: 4px;
}

/* Enhanced list item styling */
:deep(.v-list-item--active) {
  font-weight: 600;
}

/* Device Grid Layout */
.device-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  width: 100%;
  margin: 0;
  padding: 0;
}

.device-grid-item {
  flex: 1 1 auto;
  width: 100%;
  max-width: 400px;
  min-width: 320px;
}

/* Desktop - multiple columns */
@media (min-width: 900px) {
  .device-grid-item {
    flex: 0 0 auto;
    width: 400px;
  }
}

/* Tablet - 2 columns */
@media (min-width: 768px) and (max-width: 899px) {
  .device-grid-item {
    flex: 0 0 calc(50% - 12px);
    width: auto;
    max-width: none;
  }
}

/* Mobile - single column */
@media (max-width: 767px) {
  .device-grid {
    gap: 16px;
  }
  
  .device-grid-item {
    flex: 1 1 100%;
    width: 100%;
    max-width: none;
    min-width: 280px;
  }
}

/* Drag and drop styles */
.draggable-item {
  transition: all 0.3s ease;
}

/* Desktop drag styles */
@media (min-width: 768px) {
  .draggable-item {
    cursor: grab;
  }

  .draggable-item:active {
    cursor: grabbing;
  }
}

/* Mobile - no drag cursor */
@media (max-width: 767px) {
  .draggable-item {
    cursor: default;
  }
}

.ghost {
  opacity: 0.5;
}

.chosen {
  transform: rotate(2deg);
  z-index: 1000;
}

.no-effect {
  /* No visual changes - ready for future customization */
  z-index: inherit;
}

.drag {
  transform: rotate(2deg);
  opacity: 0.8;
  z-index: 1000;
}

.dragging-card {
  cursor: grabbing !important;
}

/* Override v-main in fullscreen mode */
.fullscreen-main {
  padding: 0 !important;
  margin: 0 !important;
  height: calc(100vh - 64px) !important;
  overflow: hidden !important;
}

/* Fullscreen styles */
.fullscreen-container {
  width: 100%;
  height: 100%; /* Use full v-main height */
  display: flex;
  align-items: center; /* Center vertically */
  justify-content: center; /* Center horizontally */
  padding: 0;
  margin: 0;
  box-sizing: border-box;
}

.fullscreen-card {
  /* Desktop: narrower for perfect fit */
  width: 50vw; 
  max-width: 800px; 
  height: calc(100vh - 100px); /* Fixed height to prevent internal overflow */
  min-width: 320px; /* Ensure minimum usable width */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  margin: 16px auto; /* Center horizontally with margins */
  display: flex;
  flex-direction: column;
  overflow: hidden; /* No scrolling */
}

/* Tablet responsive */
@media (max-width: 1024px) {
  .fullscreen-card {
    width: 80vw; /* Wider on tablet */
    max-width: none;
  }
}

/* Mobile responsive */
@media (max-width: 768px) {
  .fullscreen-card {
    width: 90vw; /* A bit narrower on mobile */
    margin: 8px auto; /* Smaller margins */
    height: calc(100vh - 80px); /* Account for smaller margins */
  }
}

/* Reset all container constraints in fullscreen */
.fullscreen-card :deep(.preview-container) {
  min-height: auto !important; /* Remove forced heights */
  flex: 1; /* Take available space */
  display: flex;
  flex-direction: column;
}

.fullscreen-card :deep(.v-card-text) {
  padding: 16px !important; /* Normal padding */
  flex: 1; /* Take available space */
  overflow: hidden; /* No internal scrolling */
}


.fullscreen-card :deep(.audio-meter-wrapper) {
  width: 80px;
}

.fullscreen-card :deep(.status-container) {
  min-height: 500px;
  height: 100%;
}

.fullscreen-card :deep(.controls-section) {
  margin-top: 0;
  padding-top: 0;
}

.fullscreen-card :deep(.preview-wrapper) {
  /* Use full card width in fullscreen mode */
  max-width: none; /* Remove width constraints */
  width: 100%; /* Use full card width */
  min-width: 0;
  margin: 0; /* No centering needed if using full width */
}

/* Fullscreen mode: remove gap between image and audio meter */
.fullscreen-card :deep(.d-flex.ga-2) {
  gap: 0 !important;
}


/* Fullscreen mode: make audio meter stick to image edge */
.fullscreen-card :deep(.audio-meter-wrapper) {
  margin-left: 0;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}

</style>